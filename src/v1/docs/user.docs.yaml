openapi: 3.0.0
info:
  title: API de Cocinando
  description: API para la gestión de usuarios y pagos en la aplicación Cocinando.
  contact:
    name: Cocinando Team
    email: niltongr@outlook.com
  version: 1.0.0

components:
  securitySchemes:
    jwtAuth:
      type: apiKey
      in: header
      name: Authorization

paths:
  /api/users:
    post:
      summary: Crea un nuevo usuario
      tags:
        - Usuarios
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nombreCompleto
                - email
                - contrasena
                - rol_id
              properties:
                nombreCompleto:
                  type: string
                  example: Juan Pérez
                email:
                  type: string
                  example: juan.perez@example.com
                contrasena:
                  type: string
                  format: password
                  example: "123456"
                foto:
                  type: string
                  nullable: true
                  example: "https://example.com/fotos/juan.jpg"
      responses:
        "201":
          description: Usuario creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 42
        "400":
          description: Datos inválidos o incompletos
        "500":
          description: Error del servidor

  /api/users/login:
    post:
      summary: Inicia sesión un usuario
      tags:
        - Usuarios
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - contrasena
              properties:
                email:
                  type: string
                  description: Correo electrónico del usuario
                contrasena:
                  type: string
                  format: password
            example:
              email: perez@example.com
              contrasena: "123456"
      responses:
        "200":
          description: Autenticación exitosa
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Bienvenido Juan Pérez
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        example: "19"
                      nombreCompleto:
                        type: string
                        example: Juan Pérez
                      email:
                        type: string
                        example: juan.perez@example.com
                      foto:
                        type: string
                        format: uri
                        example: https://example.com/fotos/juan.jpg
                      fechaCreacion:
                        type: string
                        format: date-time
                        example: "2025-05-17 12:19:54"
                      sessionToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        "400":
          description: Credenciales inválidas o faltantes
        "500":
          description: Error del servidor

  /api/users/logout:
    post:
      summary: Cierra la sesión del usuario
      tags:
        - Usuarios
      security:
        - jwtAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: integer
                  example: 42
      responses:
        "200":
          description: Sesión cerrada exitosamente
        "401":
          description: Token no válido o no proporcionado
        "500":
          description: Error del servidor

  /api/users/{email}:
    get:
      summary: Verificar si un usuario existe
      tags:
        - Usuarios
      parameters:
        - in: path
          name: email
          required: true
          schema:
            type: string
          description: Correo electrónico del usuario a buscar
          example: juan.perez@example.com
      responses:
        "200":
          description: Usuario encontrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
        "404":
          description: Usuario no encontrado
        "500":
          description: Error del servidor

  # MercadoPago
  /mp/preferencia:
    post:
      summary: Crea una preferencia de pago en Mercado Pago
      description: Crea una preferencia de pago utilizando la API de Mercado Pago.
      tags:
        - Pagos
      security:
        - jwtAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    type: object
                    required:
                      - id
                      - title
                      - quantity
                      - unit_price
                      - currency_id
                    properties:
                      id:
                        type: string
                        example: item-ID-1235
                      title:
                        type: string
                        example: Lomo Saltado
                      description:
                        type: string
                        example: Descripción del Item
                      category_id:
                        type: string
                        example: art
                      quantity:
                        type: integer
                        example: 2
                      unit_price:
                        type: number
                        format: float
                        example: 28.5
                      currency_id:
                        type: string
                        example: PEN
                      picture_url:
                        type: string
                        format: uri
                        example: https://www.mercadopago.com/org-img/MP3/home/logomp3.gif
              example:
                items:
                  - id: item-ID-1235
                    title: Lomo Saltado
                    description: Descripción del Item
                    category_id: art
                    quantity: 2
                    unit_price: 28.5
                    currency_id: PEN
                    picture_url: https://www.mercadopago.com/org-img/MP3/home/logomp3.gif
      responses:
        "200":
          description: Preferencia creada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: 1258945087-285a1143-a776-4b77-bb66-33471168744b
                  init_point:
                    type: string
                    format: uri
                    example: https://www.mercadopago.com.pe/checkout/v1/redirect?pref_id=1258945087-285a1143-a776-4b77-bb66-33471168744b
                  sandbox_init_point:
                    type: string
                    format: uri
                    example: https://sandbox.mercadopago.com.pe/checkout/v1/redirect?pref_id=1258945087-285a1143-a776-4b77-bb66-33471168744b
        "400":
          description: Datos inválidos o incompletos
        "500":
          description: Error interno del servidor

  /mp/suscripcion:
    post:
      summary: Crear suscripción en Mercado Pago
      description: Crea una suscripción recurrente utilizando la API de Mercado Pago.
      tags:
        - Pagos
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  example: Plan mensual premium
                auto_recurring:
                  type: object
                  properties:
                    frequency:
                      type: integer
                      example: 1
                    frequency_type:
                      type: string
                      enum: [days, months]
                      example: months
                    transaction_amount:
                      type: number
                      example: 100
                    currency_id:
                      type: string
                      example: PEN
                back_url:
                  type: string
                  format: uri
                  example: https://www.linkedin.com/in/nilton-gonzano-rojas-59aaaa132/
                notification_url:
                  type: string
                  format: uri
                  example: https://cocinando.shop/api/mercadoPago/webhook
                payer_email:
                  type: string
                  format: email
                  example: niltongr@outlook.com
      responses:
        "200":
          description: Suscripción creada con éxito
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    example: 23cfe6f2e7aa43f3a19c1df17b5d3b77
                  payer_id:
                    type: integer
                    example: 1269594862
                  payer_email:
                    type: string
                    example: ""
                  back_url:
                    type: string
                    example: https://www.linkedin.com/in/nilton-gonzano-rojas-59aaaa132/
                  collector_id:
                    type: integer
                    example: 1258945087
                  application_id:
                    type: integer
                    example: 1181137664744409
                  status:
                    type: string
                    example: pending
                  reason:
                    type: string
                    example: Plan mensual premium
                  date_created:
                    type: string
                    format: date-time
                    example: 2025-06-03T16:05:23.264-04:00
                  last_modified:
                    type: string
                    format: date-time
                    example: 2025-06-03T16:05:23.495-04:00
                  init_point:
                    type: string
                    example: https://www.mercadopago.com.pe/subscriptions/checkout?preapproval_id=23cfe6f2e7aa43f3a19c1df17b5d3b77
                  auto_recurring:
                    type: object
                    properties:
                      frequency:
                        type: integer
                        example: 1
                      frequency_type:
                        type: string
                        example: months
                      transaction_amount:
                        type: number
                        example: 100
                      currency_id:
                        type: string
                        example: PEN
                      free_trial:
                        type: string
                        nullable: true
                  summarized:
                    type: object
                    properties:
                      quotas:
                        type: string
                        nullable: true
                      charged_quantity:
                        type: string
                        nullable: true
                      pending_charge_quantity:
                        type: string
                        nullable: true
                      charged_amount:
                        type: string
                        nullable: true
                      pending_charge_amount:
                        type: string
                        nullable: true
                      semaphore:
                        type: string
                        nullable: true
                      last_charged_date:
                        type: string
                        nullable: true
                      last_charged_amount:
                        type: string
                        nullable: true
                  next_payment_date:
                    type: string
                    format: date-time
                    example: 2025-06-03T16:05:23.000-04:00
                  payment_method_id:
                    type: string
                    nullable: true
                  payment_method_id_secondary:
                    type: string
                    nullable: true
                  first_invoice_offset:
                    type: string
                    nullable: true
                  subscription_id:
                    type: string
                    example: 23cfe6f2e7aa43f3a19c1df17b5d3b77
                  owner:
                    type: string
                    nullable: true

  # logs
  /logs:
    get:
      summary: Obtener logs filtrados
      description: Retorna una lista de logs registrados en la base de datos, con filtros opcionales por método HTTP, estado HTTP y cantidad máxima.
      tags:
        - Logs
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 25
            minimum: 1
          description: Número máximo de registros a devolver.
        - in: query
          name: metodo
          schema:
            type: string
            example:
          description: Método HTTP para filtrar (GET, POST, PUT, DELETE).
        - in: query
          name: estado
          schema:
            type: integer
            example:
          description: Código de estado HTTP para filtrar.
        - in: query
          name: respuesta
          schema:
            type: number
            format: double
            example:
          description: Filtra logs cuya respuesta en ms sea mayor a este valor

      responses:
        "200":
          description: Lista de logs encontrados
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  total:
                    type: integer
                    example: 3
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1050
                        metodo:
                          type: string
                          example: GET
                        ruta:
                          type: string
                          example: /
                        cuerpo:
                          type: object
                          example: {}
                        respuesta_ms:
                          type: number
                          format: float
                          example: 825.45
                        estado_http:
                          type: integer
                          example: 200
                        mensaje:
                          type: string
                          example: OK
                        error:
                          type: object
                          nullable: true
                          example: null
                        fecha_creacion:
                          type: string
                          format: date-time
                          example: "2025-06-02T02:20:28.856Z"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  mensaje:
                    type: string
                    example: Error al obtener los logs
                  error:
                    type: string
                    example: Internal Server Error
